<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlined Event Viewer</title>
    <!-- Use Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

    <!-- Main Content Container -->
    <div class="container mx-auto p-4 md:p-8">
        <!-- Application Title -->
        <header class="text-center my-8 md:my-12">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 dark:text-gray-200 tracking-tight">
                All Events
            </h1>
        </header>

        <!-- Loading & Error Message Area -->
        <div id="status-message" class="flex justify-center items-center py-12">
            <div class="flex flex-col items-center">
                <!-- Loader SVG from Lucide Icons -->
                <svg class="h-12 w-12 animate-spin text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56" />
                </svg>
                <span class="mt-4 text-lg font-medium text-gray-600 dark:text-gray-400">Fetching events...</span>
            </div>
        </div>

        <!-- All Events Section -->
        <section id="all-events-section" class="hidden my-12">
            <div id="all-events-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
                <!-- Event cards will be dynamically inserted here -->
            </div>
        </section>
    </div>

    <script>
        // --- Sanity Image URL Builder ---
        // These values have been updated with your details
        const sanityProjectId = 'qecvakma';
        const sanityDataset = 'production';

        /**
         * Constructs a full image URL from a Sanity asset reference.
         * This function is now more robust to handle different reference formats.
         * @param {string} assetRef - The image asset _ref string (e.g., "image-...")
         * @returns {string} The full, public image URL.
         */
        function getSanityImageUrl(assetRef) {
            if (!assetRef || typeof assetRef !== 'string') {
                return 'https://placehold.co/600x400/1e293b/a8a8a8?text=No+Image';
            }
            
            // The format is "image-{id}-{dimensions}-{format}"
            // Split the string by hyphens to get the parts
            const parts = assetRef.split('-');
            
            // Check if the parts array has enough elements
            if (parts.length < 4) {
                // Fallback if the format is unexpected
                return 'https://placehold.co/600x400/1e293b/a8a8a8?text=No+Image';
            }

            // Extract the parts
            const id = parts[1];
            const dimensions = parts[2];
            const format = parts[3];

            // Reconstruct the URL for the Sanity CDN, now including dimensions
            return `https://cdn.sanity.io/images/${sanityProjectId}/${sanityDataset}/${id}-${dimensions}.${format}`;
        }

        // Get DOM elements for manipulation
        const statusMessage = document.getElementById('status-message');
        const allEventsSection = document.getElementById('all-events-section');
        const allEventsContainer = document.getElementById('all-events-container');

        /**
         * Fetches all event data from the API and renders it on the page.
         */
        async function fetchAndRenderAllEvents() {
            try {
                // Display initial loading state
                statusMessage.innerHTML = `
                    <div class="flex flex-col items-center">
                        <svg class="h-12 w-12 animate-spin text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 1 1-6.219-8.56" />
                        </svg>
                        <span class="mt-4 text-lg font-medium text-gray-600 dark:text-gray-400">Fetching events...</span>
                    </div>
                `;

                const response = await fetch('https://event-server-nine-delta.vercel.app/api/events');
                if (!response.ok) {
                    throw new Error('Failed to fetch events. Please try again later.');
                }
                const events = await response.json();
                
                // Sort all events chronologically (oldest to newest)
                events.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Clear the status message
                statusMessage.innerHTML = '';
                
                // Render the event cards
                renderAllEvents(events, allEventsContainer);

                // Show the events section if events were found
                if (events.length > 0) {
                    allEventsSection.classList.remove('hidden');
                } else {
                    allEventsContainer.innerHTML = `<p class="text-center text-lg text-gray-600 dark:text-gray-400">No events found.</p>`;
                }

            } catch (error) {
                // Display error message
                statusMessage.innerHTML = `<p class="text-center text-red-500 text-lg font-medium">Error: ${error.message}</p>`;
            }
        }

        /**
         * Renders all event cards into a specified container.
         * @param {Array} events - The array of event objects.
         * @param {HTMLElement} container - The DOM element to render into.
         */
        function renderAllEvents(events, container) {
            container.innerHTML = ''; // Clear existing content
            events.forEach(event => {
                const isUpcoming = new Date(event.date) >= new Date();
                const opacityClass = isUpcoming ? '' : 'opacity-75';

                // Get the image URL using the corrected function
                const imageUrl = event.image?.asset?._ref ? getSanityImageUrl(event.image.asset._ref) : 'https://placehold.co/600x400/1e293b/a8a8a8?text=No+Image';

                const cardHtml = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg transform transition-all duration-300 overflow-hidden ${opacityClass}">
                        <!-- Event Image -->
                        <div class="w-full h-48 overflow-hidden">
                            <img src="${imageUrl}" 
                                 alt="${event.title}" 
                                 class="w-full h-full object-cover">
                        </div>
                        
                        <!-- Event Details -->
                        <div class="p-4 space-y-3">
                            <h3 class="text-2xl font-bold truncate text-gray-800 dark:text-gray-200">
                                ${event.title}
                            </h3>
                            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-days mr-2 h-4 w-4">
                                    <path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/>
                                </svg>
                                <span class="font-medium">${new Date(event.date).toLocaleString()}</span>
                            </div>
                            <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin mr-2 h-4 w-4">
                                    <path d="M12 12a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/><path d="M12 21.7C17.3 17 21 13 21 10.2A7 7 0 0 0 12 3a7 7 0 0 0-9 7.2C3 13 6.7 17 12 21.7z"/>
                                </svg>
                                <span class="font-medium">${event.venue}</span>
                            </div>
                            <p class="text-sm mt-2 text-gray-700 dark:text-gray-300">
                                ${event.description}
                            </p>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', cardHtml);
            });
        }

        // Initial fetch and render of all events
        fetchAndRenderAllEvents();
    </script>
</body>
</html>
